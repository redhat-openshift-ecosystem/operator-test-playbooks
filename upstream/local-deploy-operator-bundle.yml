---
- name: "Deploy the operator bundle"
  hosts: all
  become: false
  gather_facts: false

  environment:
    PATH: "{{ ansible_env.PATH }}:{{ ansible_env.HOME }}/.local/bin"

  pre_tasks:
    - name: "Setup"
      setup:
      tags:
        - always
      when: run_upstream|bool

  vars:
    run_upstream: false
    default_retries: 5
    default_delay: 10
    work_dir: "/tmp/operator-test"
    testing_bin_path: "{{ work_dir }}/bin"
    jq_bin_path: "{{ testing_bin_path }}/jq"
    operators_for_index: []
    container_tool: "docker"
    opm_container_tool: "docker"
    opm_container_tool_index: "docker"
    recreate_operators_config: "{{ work_dir }}/operators_config.yaml"
    catalog_repo_dir: /tmp/community-operators-for-catalog
    bundle_registry: kind-registry:5000
    bundle_image_namespace: test-operator
    bundle_index_image_namespace: test-operator
    bundle_index_image_name: "catalog"
    app_registry_push: false

  tasks:
    - name: "Setting basic variables for deploy tasks"
      set_fact:
        operator_work_dir: "{{ work_dir }}/operator-files"
        operator_bundle_dir: "{{ work_dir }}/operator-bundle"
        jq_bin_path: "{{ testing_bin_path }}/jq"
        yq_bin_path: "{{ testing_bin_path }}/yq"
        umoci_bin_path: "{{ testing_bin_path }}/umoci"
        opm_bin_path: "{{ testing_bin_path }}/opm"
        catalog_repo_dir: /tmp/community-operators-for-catalog
        operator_sdk_bin_path: "{{ testing_bin_path }}/operator-sdk"
        oc_bin_path: '{{ ''kubectl'' if run_upstream else "{{ testing_bin_path }}/oc" }}'
        # mirror_apply: true
        doic_skip_file_check: false
        operator_upgrade_testing_disabled: false

    - name: "Load operator info from file"
      include_role:
        name: operator_info_load
      vars:
        skip_operator_info_consistency: true

    - name: "Parsing 'openshift_robot_hash' variable"
      set_fact:
        openshift_robot_hash_array: "{{ openshift_robot_hash.split('|') }}"
      no_log: true
      when:
        - openshift_robot_hash is defined
        - openshift_robot_hash|length > 0

    - name: "Quay login via auth token"
      shell: "podman login -u=\\$oauthtoken -p='{{ openshift_robot_hash_array[1] }}' quay.io"
      # no_log: true
      when: (quay_user is undefined or quay_password is undefined or quay_user|length == 0 or quay_password|length == 0) and openshift_robot_hash_array.1 is defined and openshift_robot_hash_array.1|length > 0

    - name: "Set 'force_skip_mirror' to false"
      set_fact:
        force_skip_mirror: false

    - name: "Generate Operators config file from all operators"
      block:
        - name: "Search for all operators '{{ regenerate_operators_path | basename }}'"
          find:
            paths: "{{ regenerate_operators_path }}"
            recurse: false
            file_type: directory
          register: operators_recreate_find

        - name: "Setting list of operators and operator base dir"
          set_fact:
            operators: "{{ operators_recreate_find.files | map(attribute='path' ) | map('basename') | list | sort_versions }}"
            operator_base_dir: "{{ regenerate_operators_path }}"

        - name: "Get list of all repositories in {{ bundle_image_namespace }}"
          uri:
            url: "https://quay.io/api/v1/repository?namespace={{ bundle_image_namespace }}"
            method: GET
            force_basic_auth: true
            headers:
              Authorization: "Bearer {{ quay_api_token }}"
          register: recreate_repos

        - name: "Setting list of repositories"
          set_fact:
            recreate_repos_list: "{{ recreate_repos.json.repositories | map(attribute='name') | list }}"

        - name: "Delete all repositories when doing recreate of index"
          uri:
            url: "https://quay.io/api/v1/repository/{{ bundle_image_namespace }}/{{ item }}"
            method: DELETE
            force_basic_auth: true
            headers:
              Authorization: "Bearer {{ quay_api_token }}"
            status_code: 204
            return_content: true
          with_items: "{{ recreate_repos_list }}"
          when:
            - quay_api_token is defined
            - quay_api_token|length > 0
            - (recreate_skip_repo_clean is undefined or not recreate_skip_repo_clean|bool)
      when:
        - regenerate_operators_path is defined
        - regenerate_operators_path|length > 0

    - name: "Print operators"
      debug:
        var: operators

    - name: "Print operator base dir"
      debug:
        var: operator_base_dir

    - name: "Handle operators input file"
      block:
        - name: "Parsing config file '{{ operators_config }}'"
          include_vars:
            file: "{{ operators_config }}"
            name: operators_config_vars

        - name: "Set facts from config variables"
          set_fact:
            operators: "{{ (operators_config_vars.operators | join(',')) | default('') }}"
            operator_base_dir: "{{ operators_config_vars.operator_base_dir | default('') }}"
            operator_index_operators: "{{ (operators_config_vars.operators | join(',')) | default('') }}"

        - name: "Failing when 'operator base dir' is not found in '{{ operators_config }}'"
          fail:
            msg: "'operator_base_dir' was not found in config file '{{ operators_config }}' !!!"
          when: operator_base_dir|length == 0

        - name: "Checking if operator base dir exists"
          stat:
            path: "{{ operator_base_dir }}"
          register: operator_base_dir_st

        - name: "Failing when operator base dir doesn't exists"
          fail:
            msg: "Operator base dir '{{ operator_base_dir }}' was not found !!!"
          when: not operator_base_dir_st.stat.exists

        - name: "Failing when 'operator_base_dir' is not defined or is empty"
          fail:
            msg: "The 'operator_base_dir' is not defined or is empty"
          when: operator_base_dir|length == 0
      when: operators_config is defined

    - name: "Set operator name to list from operator name"
      set_fact:
        operators: "{{ operator_dir | basename }}"
      when:
        - operator_dir is defined
        - operators is undefined
        - operators_config is undefined
        - regenerate_operators_path is undefined

    - name: "Setting 'operators_for_index' variable"
      set_fact:
        operators_for_index: "{{ operators_for_index }}"

    - name: "Test 'force_skip_mirror' to true"
      set_fact:
        force_skip_mirror: true
        vvv: "latest"
      when: bundle_index_image_version is undefined or bundle_index_image_version|length == 0 or bundle_index_image_version == "latest"

    - name: "Test 'force_skip_mirror' to true"
      set_fact:
        force_skip_mirror: true
        vvv: "{{ bundle_index_image_version[1:] }}"
      when:
        - bundle_index_image_version is defined
        - bundle_index_image_version|length > 0
        - bundle_index_image_version != "latest"

    - name: "Deploy operators bundle images"
      set_fact:
        force_skip_mirror: false
      loop: "{{ operators.split(',') }}"
      loop_control:
        loop_var: op_item
      when:
        - run_upstream|bool
        - op_info[op_item].index[vvv] is defined
        - op_info[op_item].index[vvv]|length > 0

    - name: "Print 'force_skip_mirror'"
      debug:
        var: force_skip_mirror

    - name: "Deploy operators bundle images"
      include_role:
        name: build_operator_bundle
      vars:
        operator_dir: "{{ operator_base_dir }}/{{ op_item }}"
      loop: "{{ operators.split(',') }}"
      loop_control:
        loop_var: op_item
      when:
        - run_upstream|bool
        - not force_skip_mirror|bool

    - name: Handle index changes
      block:
        - name: "Deploy operators to index"
          include_role:
            name: build_operators_index
          when:
            - run_upstream|bool
            - not operator_removed|bool

        # - name: "Handling that mirror will not occur when 'operators_for_index' is empty when 'deploy_bundles' is defined"
        #   set_fact:
        #     mirror_apply: false
        #   tags:
        #     - deploy_bundles
        #   when:
        #     - operators_for_index.0 is undefined
        - name: "Set Index check variable"
          block:
            - name: "Setting operator base dir"
              set_fact:
                ldob_operator_base_dir: "{{ operator_base_dir }}"
              when:
                - operator_base_dir is defined

            - name: "Checking if operator base dir exists"
              stat:
                path: "{{ catalog_repo_dir }}/operators"
              register: ldob_operator_dir_st
              ignore_errors: true

            - name: "Setting operator base dir"
              set_fact:
                ldob_operator_base_dir: "{{ catalog_repo_dir }}/operators"
              when:
                - ldob_operator_dir_st.stat.exists

            - name: "Index sanity check"
              include_role:
                name: check_index
              vars:
                ci_operator_base_dir: "{{ ldob_operator_base_dir }}"
          tags:
            - mirror_index
            - deploy_bundles
            - index_check
          when:
            - run_upstream|bool
            - bundle_index_image is defined
            - bundle_index_image|length > 0
            - (openshift_robot_hash is undefined or openshift_robot_hash|length == 0)

        - name: "Debug"
          block:
            - name: "Debug"
              debug:
                var: run_upstream

            - name: "Debug"
              debug:
                var: bundle_index_image

            - name: "Debug"
              debug:
                var: mirror_index_images

            - name: "Debug"
              debug:
                var: operators_for_index

            - name: "Debug"
              debug:
                var: operators_for_index.0

            - name: "Debug"
              debug:
                var: openshift_robot_hash
          when: op_info is undefined
          tags:
            - mirror_index
            - deploy_bundles

        - name: "Mirror index image"
          include_role:
            name: mirror_image
          vars:
            mirror_input_image: "{{ bundle_index_image }}"
          tags:
            - mirror_index
            - deploy_bundles
          when:
            - run_upstream|bool
            - bundle_index_image is defined
            - bundle_index_image|length > 0
            - mirror_index_images is defined
            - mirror_index_images|length > 0
            # - mirror_apply|bool
            - (operators_for_index.0 is defined) or (mirror_apply is defined and mirror_apply|bool)
            - (openshift_robot_hash is undefined or openshift_robot_hash|length == 0)
            - force_skip_mirror is not defined or not force_skip_mirror|bool
            - index_skip is undefined or not index_skip|bool

        - name: "Handle failed operators"
          include_role:
            name: handle_failed_operators
          tags:
            - mirror_index
            - deploy_bundles
            - index_check
          when:
            - run_upstream|bool
            - (openshift_robot_hash is undefined or openshift_robot_hash|length == 0)

        - debug:
            var: operator_upgrade_testing_disabled

        - debug:
            var: cluster_type

        - debug:
            var: operator_bundle_version_for_upgrade

        - name: "Test operator upgrade"
          include_role:
            name: test_operator_update
          when:
            - operator_bundle_version_for_upgrade is defined
            - operator_bundle_version_for_upgrade|length != 0
            - cluster_type is defined
            - cluster_type == "k8s"
            - (operator_upgrade_testing_disabled is not defined) or (operator_upgrade_testing_disabled|bool == false)

      when:
        - index_skip is undefined or not index_skip|bool
        - force_skip_mirror is not defined or not force_skip_mirror|bool

    - name: "Push to Quay (old AppRegistry)"
      include_role:
        name: push_to_quay
      when:
        - run_upstream|bool
        - quay_appregistry_courier_token is defined
        - quay_appregistry_courier_token|length > 0
