---
- name: "Handle Operator index (new)"
  block:
    - name: "Prepare operator info for loop"
      set_fact:
        oi_operators: "{{ op_info.keys() | list }}"

    # - name: "Prepare operators from file for loop"
    #   set_fact:
    #     oi_operators: "{{ operators }}"
    #   when: operators is defined

    - name: ""
      set_fact:
        oi_operators: "{{ operator_index_operators.split(',') | list }}"
      when: 
        - operator_index_operators is defined
        - operator_index_operators|length > 0

    - name: "Loop over all versions"
      include_tasks: op_index.yml
      vars:
        io_index_ver: "{{ bundle_index_image_version }}"
      loop: "{{ oi_operators }}"
      loop_control:
        loop_var: oi_op_name
      # when:
      #   - operator_index_operators is undefined or operator_index_operators|length == 0

    # - name: "Loop over all versions"
    #   include_tasks: op_index.yml
    #   vars:
    #     io_index_ver: "{{ bundle_index_image_version }}"
    #   loop: "{{ operator_index_operators.split(',') | list }}"
    #   loop_control:
    #     loop_var: oi_op_name
    #   when:
    #     - operator_index_operators is defined
    #     - operator_index_operators|length > 0

    - name: "Print failed 'oi_failed_index_add'"
      debug:
        var: oi_failed_index_add
      when: oi_failed_index_add.0 is defined

    - name: "Print failed 'oi_failed_index_dt'"
      debug:
        var: oi_failed_index_dt
      when: oi_failed_index_dt.0 is defined

    - name: "Failing when some operators failed"
      fail:
        msg: "Some operators failed. List is above !!!"
      when: oi_failed_index_add.0 is defined or oi_failed_index_dt.0 is defined

  when: op_info is defined
