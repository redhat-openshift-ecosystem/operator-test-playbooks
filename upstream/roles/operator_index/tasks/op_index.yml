---
- name: "Print 'oi_op_info'"
  debug:
    var: oi_op_info

# - name: "Set versions and versions_bt"
#   set_fact:
#     io_index_ver: "v4.9"

- name: "Set versions and versions_bt"
  set_fact:
    oi_versions: "{{ oi_op_info.versions }}"
    oi_versions_dt: "{{ oi_op_info.index_dt['4.9'] }}"
    oi_index: "{{ bundle_registry }}/{{ bundle_index_image_namespace }}/{{ bundle_index_image_name }}:{{ io_index_ver }}"
    oi_mode: "{{ oi_op_info.mode }}"
    oi_bundles_exists: "{{ oi_op_info.versions | symmetric_difference(oi_op_info.index_dt['4.9']) }}"
    oi_bundles: []
    oi_bundles_dt: []

- name: "Print 'oi_bundles_exists'"
  debug:
    var: oi_bundles_exists

- name: "Remove '{{ oi_op_info.name }}' operator to index image {{ oi_index }}"
  shell: "{{ opm_bin_path }} index rm -c {{ opm_container_tool }} --operators {{ oi_op_info.name }} --tag {{ oi_index }} --from-index {{ oi_index }}"

- name: "Push index image {{ oi_index }}"
  shell: "{{ opm_container_tool }} push {{ oi_index }}"

- name: "Check if any version can be aded"
  block:

    - name: "Print 'operator_info_vars'"
      set_fact:
        oi_bundles: "{{ oi_bundles | default([]) + [ bundle_registry+'/'+bundle_image_namespace+'/'+ oi_op_info.name+ ':v' + oi_ver ] }}"
      loop: "{{ oi_versions }}"
      loop_control:
        loop_var: oi_ver

    - name: "Print 'operator_info_vars'"
      set_fact:
        oi_bundles_dt: "{{ oi_bundles_dt | default([]) + [ bundle_registry+'/'+bundle_image_namespace+'/'+ oi_op_info.name+ ':v' + oi_ver ] }}"
        # oi_bundles_dt: "{{ bundle_registry }}/{{ bundle_image_namespace }}/{{ oi_op_info.name  }}:v{{ oi_versions_dt[-1] }}"
      loop: "{{ oi_versions_dt }}"
      loop_control:
        loop_var: oi_ver

    - name: "Print 'oi_bundles'"
      set_fact:
        oi_bundles_str: "{{ oi_bundles | join(',') }}"
        oi_bundles_dt_str: "{{ oi_bundles_dt | join(',') }}"

    - name: "Print 'oi_bundles'"
      debug:
        var: oi_bundles

    - name: "Print 'oi_bundles_dt'"
      debug:
        var: oi_bundles_dt

    - name: "Print 'oi_bundles_str'"
      debug:
        var: oi_bundles_str

    - name: "Add '{{ oi_op_info.name }}' operator to index image {{ oi_index }}"
      shell: "{{ opm_bin_path }} index add -c {{ opm_container_tool }} --bundles {{ oi_bundles_str }} --tag {{ oi_index }} --from-index {{ oi_index }} --mode {{ oi_mode }}"

    - name: "Push index image {{ oi_index }}"
      shell: "{{ opm_container_tool }} push {{ oi_index }}"

    - name: "Handle deprecatetruncate"
      block:
        - name: "Index deprecatetruncate '{{ oi_op_info.name }}' operator to index image {{ oi_index }}"
          shell: "{{ opm_bin_path }} index deprecatetruncate -c {{ opm_container_tool }} --bundles {{ oi_bundles_dt_str }} --tag {{ oi_index }} --from-index {{ oi_index }}"
          ignore_errors: true

        - name: "Push index image {{ oi_index }}"
          shell: "{{ opm_container_tool }} push {{ oi_index }}"
      when: oi_bundles_dt.0 is defined

  when: oi_bundles_exists.0 is defined
# - pause:
