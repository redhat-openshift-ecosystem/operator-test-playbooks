---
- debug:
    var: hobvo_result
- name: "Get output"
  set_fact:
    hobvo_bundle_validate_error: "{{ hobvo_result.stdout | from_json }}"

- name: "Print 'hobvo_bundle_validate_error.outputs'"
  debug:
    var: hobvo_bundle_validate_error.outputs|type_debug

- name: "Reset 'hobvo_bundle_validate_error_outputs'"
  set_fact:
    hobvo_bundle_validate_error_outputs: []

- name: "Set 'hobvo_bundle_validate_error_outputs"
  set_fact:
    hobvo_bundle_validate_error_outputs: "{{ hobvo_bundle_validate_error.outputs }}"
  when: hobvo_bundle_validate_error.outputs|type_debug != "NoneType"

- name: "Print bundle validate errors"
  debug:
    var: hobvo_bundle_validate_error

- name: "Generate file '{{ hobvo_error_file }}'"
  block:
    - name: "Make sure that '{{ operator_work_dir }}' exits"
      file:
        path: "{{ operator_work_dir }}"
        state: directory

    - name: "Remove '{{ hobvo_error_file }}'"
      file:
        path: "{{ hobvo_error_file }}"
        state: absent

    - name: "Create header '{{ hobvo_error_file }}'"
      lineinfile:
        path: "{{ hobvo_error_file }}"
        line: "| Type | Message |"
        create: yes

    - name: "Create header 2 '{{ hobvo_error_file }}'"
      lineinfile:
        path: "{{ hobvo_error_file }}"
        line: "|---|---|"

    - name: "Add errors to file '{{ hobvo_error_file }}'"
      lineinfile:
        path: "{{ hobvo_error_file }}"
        line: "| {{ item.type }} | {{ item.message | replace('Error: ','')}} |"
      loop: "{{ hobvo_bundle_validate_error_outputs }}"
      when: item.type == "error"

    - name: "Add warnings to file '{{ hobvo_error_file }}'"
      lineinfile:
        path: "{{ hobvo_error_file }}"
        line: "| {{ item.type }} | {{ item.message | replace('Warning: ','')}} |"
      loop: "{{ hobvo_bundle_validate_error_outputs }}"
      when: item.type == "warning"

    - name: "Cat content of '{{ hobvo_error_file }}'"
      shell: "cat {{ hobvo_error_file }}"
      register: hobvo_error_file_result

    - name: "Print content"
      debug:
        var: hobvo_error_file_result

  when:
    - hobvo_bundle_validate_error_outputs.0 is defined
    - run_upstream|bool
