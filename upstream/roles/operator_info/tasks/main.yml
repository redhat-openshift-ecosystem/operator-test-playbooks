---
- name: "Operator info"
  block:
    - name: "Print operator dir"
      debug:
        var: operator_base_dir

- name: "Handle situation when 'operator_dir' is defined"
  set_fact:
    operators: "{{ operator_dir | basename }}"
    operator_base_dir: "{{ operator_dir | dirname }}"
  when:
    - operator_dir is defined
    - operator_dir|length > 0

- name: "Handle operators input file"
  block:
    - name: "Parsing config file '{{ operators_config }}'"
      include_vars:
        file: "{{ operators_config }}"
        name: operators_config_vars
    - name: "Set facts from config variables"
      set_fact:
        operators: "{{ (operators_config_vars.operators | join(',')) | default('') }}"
        operator_base_dir: "{{ operators_config_vars.operator_base_dir | default('') }}"
    - name: "Failing when 'operator base dir' is not found in '{{ operators_config }}'"
      fail:
        msg: "'operator_base_dir' was not found in config file '{{ operators_config }}' !!!"
      when: operator_base_dir|length == 0
    - name: "Checking if operator base dir exists"
      stat:
        path: "{{ operator_base_dir }}"
      register: operator_base_dir_st
    - name: "Failing when operator base dir doesn't exists"
      fail:
        msg: "Operator base dir '{{ operator_base_dir }}' was not found !!!"
      when: not operator_base_dir_st.stat.exists
    - name: "Failing when 'operator_base_dir' is not defined or is empty"
      fail:
        msg: "The 'operator_base_dir' is not defined or is empty"
      when: operator_base_dir|length == 0
  when: operators_config is defined


- name: "Ensure that the 'operator_bundle_src_dir' directory exists and is empty"
  file:
    state: "{{ item }}"
    path: "{{ operator_bundle_src_dir }}"
  with_items:
    - absent
    - directory

- name: "Resetting 'op_info' object"
  set_fact:
    op_info: []

- name: "Loop over operators"
  include_tasks: op_info.yml
  loop: "{{ operators.split(',') }}"
  loop_control:
    loop_var: oi_operator_name

- name: "Print 'op_info'"
  debug:
    var: op_info

- name: "Generate operators info config file"
  copy: content="operators:\n{{ op_info | to_nice_yaml }}" dest="{{ operator_info_output_file }}"

# - name: "Build index"
#   include_role:
#     name: operator_index

# - name: "Parsing config file '{{ operator_info_output_file }}'"
#   include_vars:
#     file: "{{ operator_info_output_file }}"
#     name: operator_info_vars

# - name: "Resetting 'op_info' object"
#   set_fact:
#     op_info: operator_info_vars.operators

# - name: "Print 'operator_info_vars'"
#   debug:
#     var: operator_info_vars.operators[0].replaces[test]

# - name: "Pause"
#   pause:
