---

- name: "Remove postifx from index version"
  set_fact:
    pei_version: "{{ pu_item.split('-')[0] }}"

- name: "Check if version '{{ pei_version }}' is in 'versions_in_registry'"
  block:
    - debug:
        msg: "Upgrading '{{ pei_version }}' from '{{ pu_from_index }}' index"

    - name: "Remove postifx from index version"
      set_fact:
        pei_version_s: "{{ pei_version }}{{ pu_postfix | default('')}}"
        pei_version_i: "{{ pei_version }}i"

    - name: "Copy {{ pu_from_index }} to {{ default_config.production.index.registry }}/{{ default_config.production.index.organization }}/{{ default_config.production.index.name }}:{{ pei_version }}"
      shell: "skopeo copy docker://{{ pu_from_index }} docker://{{ default_config.production.index.registry }}/{{ default_config.production.index.organization }}/{{ default_config.production.index.name }}:{{ pei_version }}"

    - name: "Copy {{ pu_from_index }}{{ pu_postfix }} to {{ default_config.production.index.registry }}/{{ default_config.production.index.organization }}/{{ default_config.production.index.name }}:{{ pei_version_s }}"
      shell: "skopeo copy docker://{{ pu_from_index }}{{ pu_postfix }} docker://{{ default_config.production.index.registry }}/{{ default_config.production.index.organization }}/{{ default_config.production.index.name }}:{{ pei_version_s }}"
      when: pei_version_s not in versions_in_registry

    - name: "Copy {{ pu_from_index }}i to {{ default_config.production.index.registry }}/{{ default_config.production.index.organization }}/{{ default_config.production.index.name }}:{{ pei_version }}i"
      shell: "skopeo copy docker://{{ pu_from_index }}i docker://{{ default_config.production.index.registry }}/{{ default_config.production.index.organization }}/{{ default_config.production.index.name }}:{{ pei_version }}i"
      when: pei_version_i not in versions_in_registry

  when: pei_version not in versions_in_registry

- name: "Check if version '{{ pei_version }}' is in 'versions_in_registry'"
  block:
    - debug:
        msg: "Index '{{ default_config.production.index.registry }}/{{ default_config.production.index.organization }}/{{ default_config.production.index.name }}:{{ pei_version }}' already exists"
  when: pei_version in versions_in_registry
